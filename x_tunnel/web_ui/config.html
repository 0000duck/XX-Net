<ul class="nav nav-tabs">
    <li class="active"><a href="#summary" data-toggle="tab">{{ _( "Summary" ) }}</a></li>
    <li class="hide"><a href="#plan" data-toggle="tab">{{ _( "Plan" ) }}</a></li>
    <li class="hide"><a href="#history" data-toggle="tab">{{ _( "History" ) }}</a></li>
</ul>
<div class="tab-content">
    <div id="summary" class="tab-pane fade in active">
        <form id="login-form" onSubmit="onLoginSubmit(); return false;">
            <h5>{{ _( "Login" ) }}</h5>
            <p>
                <label for="login-username">{{ _( "Email" ) }}</label>
                <input id="login-username" type="text" />
            </p>
            <p>
                <label for="login-password">{{ _( "Password" ) }}</label>
                <input id="login-password" type="password" />
            </p>
            <p>
                <button class="btn btn-primary btn-block" type="submit">{{ _( "Login" ) }}</button>
            </p>
            <p class="text-center">
                <a id="register-trigger" href="javascript:void(0);">{{ _( "Haven't an account?" ) }}</a>
            </p>
        </form> <!-- #login-form -->
        <form id="register-form" class="hide" onSubmit="onRegisterSubmit(); return false;">
            <h5>{{ _( "Register" ) }}</h5>
            <p>
                <label for="register-username">{{ _( "Email" ) }}</label>
                <input id="register-username" type="text" />
            </p>
            <p>
                <label for="register-password">{{ _( "Password" ) }}</label>
                <input id="register-password" type="password" />
            </p>
            <p>
                <button class="btn btn-primary btn-block" type="submit">{{ _( "Register" ) }}</button>
            </p>
            <p class="text-center">
                <a id="login-trigger" href="javascript:void(0);">{{ _( "Already have an account?" ) }}</a>
            </p>
        </form> <!-- #register-form -->
        <div id="account-information" class="hide">
            <div class="row-fluid">
                <div class="span4">
                    <label for="login-account">{{ _( "Account" ) }}</label>
                </div> <!-- .span4 -->
                <div class="span8">
                    <p>
                        <span id="login-account">N/a</span>
                        <a id="logout-trigger" href="javascript:void(0)">[{{ _("Logout") }}]</a>
                    </p>
                </div> <!-- .span8 -->
            </div> <!-- .row-fluid -->
            <div class="row-fluid">
                <div class="span4">
                    <label for="balance">{{ _( "Balance" ) }}</label>
                </div> <!-- .span4 -->
                <div class="span8">
                    <p>
                        <span id="balance">N/a</span>
                        <a id="charge-trigger" href="javascript:void(0);">[{{ _( "Charge" ) }}]</a>
                        <a id="transfer-trigger" href="javascript:void(0);">[{{ _( "Transfer" ) }}]</a>
                    </p>
                </div> <!-- .span8 -->
            </div> <!-- .row-fluid -->
            <div class="row-fluid">
                <div class="span4">
                    <label for="bandwidth">{{ _( "Bandwidth" ) }}</label>
                </div> <!-- .span4 -->
                <div class="span8">
                    <p>
                        <span id="bandwidth">N/a</span>
                    </p>
                </div> <!-- .span8 -->
            </div> <!-- .row-fluid -->
        </div> <!-- #account-information -->
    </div> <!-- #summary -->
    <div id="plan" class="tab-pane fade in">

    </div> <!-- #plan -->
    <div id="history" class="tab-pane fade in">
        <div class="row-fluid">
            <div class="span6">
                <h4>{{ _( "History" ) }}</h4>
            </div> <!-- .span6 -->
            <div class="span6 text-right">
                <button class="btn btn-primary" id="get-history-button">{{ _( "Get" ) }}</button>
            </div> <!-- .span6 -->
        </div> <!-- .row-fluid -->
        <table id="history-list" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th >{{ _( "Time" ) }}</th>
                    <th>{{ _( "Action" ) }}</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div> <!-- #history -->
</div> <!-- #tab-content -->

<!-- Modals -->
<form id="charge-modal" class="modal hide fade" action="https://www.paypal.com/cgi-bin/webscr" method="POST" target="_blank">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h5>{{ _( "Charge" ) }}</h5>
    </div> <!-- .modal-header -->
    <div class="modal-body">
        <!-- Plan Field -->
        <input type="hidden" name="on0" value="Plan">
        <label for="charge-plan">{{ _( "Plan" ) }}:</label>
        <select id="charge-plan" name="os0">
            <option value="Quarterly">{{ _( "Quarterly" ) }} $4.50</option>
            <option value="Yearly">{{ _( "Yearly" ) }} $15.00</option>
        </select> 
        <!-- Account Field -->
        <input type="hidden" name="on1" value="Account">
        <input class="login-account" type="hidden" name="os1">
    </div> <!-- .modal-body -->
    <div class="modal-footer">
        <input type="hidden" name="cmd" value="_s-xclick">
        <input type="hidden" name="hosted_button_id" value="WBX5H8PS54N22">
        <input type="hidden" name="currency_code" value="USD">
        <a href="javascript:void(0);" class="btn" data-dismiss="modal">{{ _("Close") }}</a>
        <button class="btn btn-primary">{{ _("Buy Now") }}</button>
    </div> <!-- .modal-footer -->
</form> <!-- #charge-modal -->
<div id="transfer-modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h5>{{ _( "Transfer" ) }}</h5>
    </div> <!-- .modal-header -->
    <div class="modal-body">
        <div class="alert alert-error hide"></div> <!-- .alert-error -->
        <p>
            <label for="transfer-username">{{ _( "Transfer Username" ) }}</label>
            <input id="transfer-username" type="text" placeholder="{{ _("Email Address") }}" />
        </p>
        <p>
            <label for="transfer-amount">{{ _( "Transfer Amount" ) }}</label>
            <input id="transfer-amount" type="text" value="0" onkeyup="isDecimalNumber(this)" />
        </p>
    </div> <!-- .modal-body -->
    <div class="modal-footer">
        <a href="javascript:void(0);" class="btn" data-dismiss="modal">{{ _("Close") }}</a>
        <button class="btn btn-primary">{{ _("Transfer") }}</button>
    </div> <!-- .modal-footer -->
</div> <!-- #transfer-modal -->

<!-- Java Script -->
<script type="text/javascript">
    title('X Tunnel');
</script>
<script type="text/javascript">
    $(function() {
        getUserLoggedIn();
    });
</script>
<!-- Summary -->
<script type="text/javascript">
    $('#register-trigger').click(function() {
        $('#login-form').addClass('hide');
        $('#register-form').removeClass('hide');
    });
</script>
<script type="text/javascript">
    $('#login-trigger').click(function() {
        $('#register-form').addClass('hide');
        $('#login-form').removeClass('hide');
    });
</script>
<script type="text/javascript">
    function getUserLoggedIn() {
        $.ajax({
            type: 'GET',
            url: '/module/x_tunnel/control/info',
            dataType: 'JSON',
            success: function(result) {
                if( result['res'] == 'success' ) {
                    getHistory();

                    $('.nav-tabs > li').removeClass('hide');
                    $('#login-form').addClass('hide');
                    $('#account-information').removeClass('hide');

                    $('#login-account').html(result['login_account']);
                    $('.login-account').val(result['login_account']);
                    $('#balance').html(getBalanceForHunmanReading(result['balance']));
                    $('#bandwidth').html(getBandwidthForHumanReading(result['quota']));
                }
            }
        });
    }
</script>
<script type="text/javascript">
    function getBalanceForHunmanReading(balance) {
        if ( parseFloat(balance) == 0 ) {
            $('#transfer-trigger').addClass('hide');
        }
        return '$ ' + parseFloat(balance).toFixed(2);
    }
</script>
<script type="text/javascript">
    function getBandwidthForHumanReading(bandwidth) {
        var base        = 1024,
            bandwidth   = Math.round(bandwidth) / base / base;

        if ( bandwidth > base ) {
            bandwidth = bandwidth / base;
            bandwidth = parseFloat(bandwidth).toFixed(2) + ' G';
        } else {
            bandwidth = parseFloat(bandwidth).toFixed(2) + ' M';
        }
        return bandwidth;
    }
</script>
<script type="text/javascript">
    function isEmailLegal(email) {
        var regx = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return regx.test(email);
    }
</script>
<script type="text/javascript">
    function onLoginSubmit() {
        var username = $('#login-username').val(),
            password = $('#login-password').val();

        if ( !isEmailLegal(username) ) {
            tip('{{ _( "Email seems invalid." )}}', 'error', false);
        } else if ( password.length < 6 ) {
            tip('{{ _( "Password needs at least 6 charactors." ) }}', 'error', false);
        }

        $('button[type=submit]', '#login-form').html('{{ _("Please wait...") }}');
        $('button[type=submit]', '#login-form').attr('disabled', 'disabled');
        return doLoginAction(username, password);
    }
</script>
<script type="text/javascript">
    function doLoginAction(username, password) {
        var postData = {
            'username': username, 
            'password': password,
            'is_register': 0
        };

        $.ajax({
            type: 'POST',
            url: '/module/x_tunnel/control/login',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                if ( result['res'] == 'success' ) {
                    window.location.reload();
                } else {
                    tip('{{ _("Incorrect Email or password.") }}', 'error', false);

                    $('button[type=submit]', '#login-form').html('{{ _("Login") }}');
                    $('button[type=submit]', '#login-form').removeAttr('disabled');
                }
            }
        });
    }
</script>
<script type="text/javascript">
    function onRegisterSubmit() {
        var username = $('#register-username').val(),
            password = $('#register-password').val();

        if ( !isEmailLegal(username) ) {
            tip('{{ _( "Email seems invalid." )}}', 'error', false);
        } else if ( password.length < 6 ) {
            tip('{{ _( "Password needs at least 6 charactors." ) }}', 'error', false);
        }

        $('button[type=submit]', '#register-form').html('{{ _("Please wait...") }}');
        $('button[type=submit]', '#register-form').attr('disabled', 'disabled');
        return doRegisterAction(username, password);
    }
</script>
<script type="text/javascript">
    function doRegisterAction(username, password) {
        var postData = {
            'username': username, 
            'password': password,
            'is_register': 1
        };

        $.ajax({
            type: 'POST',
            url: '/module/x_tunnel/control/register',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                if ( result['res'] == 'success' ) {
                    return doLoginAction(username, password);
                } else {

                    if ( result['reason'] == 'user exist' ) {
                        tip('{{ _("Email has been taken by another user.") }}', 'error', false);
                    } else {
                        tip('{{ _("Unknown error occurred.") }}', 'error', false);
                    }

                    $('button[type=submit]', '#register-form').html('{{ _("Register") }}');
                    $('button[type=submit]', '#register-form').removeAttr('disabled');
                }
            }
        });
    }
</script>
<script type="text/javascript">
    $('#logout-trigger').click(function() {
        $.ajax({
            type: 'POST',
            url: '/module/x_tunnel/control/logout',
            dataType: 'JSON',
            success: function(result) {
                $('ul.nav-tabs > li').not(':first').addClass('hide');
                $('#account-information').addClass('hide');
                $('#login-form').removeClass('hide');
            },
            error: function(result) {
                tip('{{ _("Failed to log out.") }}', false);   
            }
        });
    });
</script>
<script type="text/javascript">
    $('#charge-trigger').click(function() {
        $('#charge-modal').modal();
    });
</script>
<script type="text/javascript">
    $('.btn-primary', '#charge-modal').click(function() {
        $(this).attr('disabled', 'disabled');
        $(this).html('{{ _("Please refresh page.") }}');

        $('#charge-modal').submit();
    });
</script>
<script type="text/javascript">
    $('#transfer-trigger').click(function() {
        $('.alert', '#transfer-modal').addClass('hide');
        $('#transfer-modal').modal();
    });
</script>
<script type="text/javascript">
    $('.btn-primary', '#transfer-modal').click(function() {
        var transferAccount = $('#transfer-username').val(),
            transferAmount  = $('#transfer-amount').val();

        if ( !isEmailLegal(transferAccount) ) {
            $('.alert', '#transfer-modal').html('{{ _("Transfer username seems not a valid Email address.") }}');
            $('.alert', '#transfer-modal').removeClass('hide');
            return;
        }
        console.log('Test');
        return doTransferAction(transferAccount, transferAmount);
    });
</script>
<script type="text/javascript">
    function doTransferAction(transferAccount, transferAmount) {
        var postData = {
            'to_account': transferAccount,
            'amount': transferAmount,
            'transfer_type': 'balance'
        };

        $.ajax({
            type: 'POST',
            url: '/module/x_tunnel/control/transfer',
            data: postData,
            dataType: 'JSON',
            success: function(result) {
                if ( result['res'] == 'success' ) {
                    window.location.reload();
                } else {
                    $('.alert', '#transfer-modal').html('{{ _("Error occurred: ") }}' + result['reason']);
                    $('.alert', '#transfer-modal').removeClass('hide');
                }
            }
        });
    }
</script>
<script type="text/javascript">
    function isDecimalNumber(obj) {
        if ( isNaN(obj.value) ) {
             obj.value = '';
         }
         if ( obj != null ) {
             if ( obj.value.toString().split('.').length > 1 && 
                    obj.value.toString().split(".")[1].length > 2 ) {
                alert('{{ _("Transfer amount should not more than 2 decimal places.") }}');
                 obj.value = '';
             }
         }
    }
</script>
<!-- History -->
<script type="text/javascript">
    $('#get-history-button').click(function() {
        getHistory();

        $('#get-history-button').attr('disabled', 'disabled');
        $('#get-history-button').html('Please wait...');
    });
</script>
<script type="text/javascript">
    function getHistory() {
        $('#history-list tbody').empty();

        $.ajax({
            type: 'GET',
            data: {
                'start': 1999999999, 
                'end': 0, 
                'limit': 1000
            },
            url: '/module/x_tunnel/control/get_history',
            dataType: 'JSON',
            success: function(result) {
                if( result['res'] != 'success' ){
                    tip('Get Fail:' + result['reason'], 'warning', false);
                } else {
                    tipClose();
                }

                result['history'].forEach(function(entry) {
                    insertHistory(entry[1]);
                });

                $('#get-history-button').html('{{ _( "Get" ) }}');
                $('#get-history-button').removeAttr('disabled');
            }
        });
    }
</script>
<script type="text/javascript">
    function insertHistory(item){
        var timeString = item['time'];
        delete item['time']; 

        var message = '';
        for ( property in item ) {
            message += property + ':' + item[property]+'; ';
        }

        $('#history-list tbody').append('<tr><td>%s</td><td>%s</td></tr>'.format(timeString, message));
    }
</script>